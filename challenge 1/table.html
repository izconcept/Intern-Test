<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge1</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script type="text/javascript">

        // Used to sort an array of numbers
        function sortNumber(a,b) {
            return a - b;
        }

        // Creates the table
        function displayTable() {
            $(".removeable").remove()

            books.forEach(function(book) {
                $("table").append("<tr class='removeable'></tr>")
                Object.keys(book).forEach(function(key) {
                    $("tr").last().append("<td>" + book[key] + "</td>")
                })
            })
        }

        function sortCatalog(header) {
            // Declare a dictionary that will store the contents as keys and their locations as values
            dic = {};

            for(i = 0; i < books.length; i++) {
                // If there are more one key has several books associated with it, store those index locations in an array
                if(dic[books[i][header]] instanceof Array) {
                    dic[books[i][header]].push(i)
                }
                else if(books[i][header] in dic) {
                    arr = [dic[books[i][header]], i]
                    dic[books[i][header]] = arr;
                } else {
                    dic[books[i][header]] = i;
                }
            }

            // Will be used as a lookup table to sort the new books list
            sorted = Object.keys(dic)

            // Check if it's a number or not to determine how to sort it
            if(isNaN(sorted[0])) {
                sorted.sort()
            } else {
                sorted.sort(sortNumber)
            }

            // Create a newBooks object to replace the books object with the correctly sorted version
            newBooks = []

            // Iteratively create the the new books object using the sorted list as a look up table
            for(i = 0 ; i < sorted.length; i++) {
                // If it's an array, iterate over that array
                if(dic[sorted[i]] instanceof Array) {
                    for(j = 0; j < dic[sorted[i]].length ; j++) {
                        newBooks.push(books[dic[sorted[i]][j]]);
                    }
                } else {
                    newBooks.push(books[dic[sorted[i]]]);
                }
            }

            books = newBooks;
            displayTable();
        }

        function reverseCatalog() {
            books.reverse();
            displayTable();
        }
    </script>

    <style>
        th:hover {
            background-color: #666dc4;
            color: white;
            cursor: pointer;
        }
        .selected {
            background-color: rgba(0,0,0,.2)
        }
    </style>
</head>
<body>
    <div class="container">
    <h1 style="text-align: center; margin: 30px;">Catalog</h1>
        <table class="table table-responsive table-striped">
            <tr id="tHead"></tr>
        </table>
    </div>

    <script type="text/javascript">

        var books;

        $(function() {
            $.ajax({
                type: "GET",
                // Hosting JSON on personal server so I can retrieve it without having to run a local server to distribute files
                url: "http://izkevin.com/distributer/parsedXML.txt",
                success: function(data) {
                    file = JSON.parse(data);

                    // Create headers for the table
                    headers = Object.keys(file['catalog']['book'][0]);
                    headers.forEach(function(header) {
                        $("#tHead").append("<th>"+header+"</th>");
                    });

                    // Store catalog in our global books variable
                    books = file['catalog']['book'];

                    displayTable()
                }
            })
        })

        // Collumn sorts the table based on the header that was clicked
        $('table').on("click", "th", function() {
            if($(this).hasClass("selected")) {
                reverseCatalog()
            } else {
                $('th').removeClass("selected")
                $(this).addClass("selected")
                header = $(this).text()
                sortCatalog(header);
            }
        })
    </script>
</body>
</html>